import { test, expect } from '@playwright/test';

{
  "description": "Comprehensive test suite for verifying project access restrictions for invited users (RA-104). Tests cover negative scenarios where invited users cannot access projects until invitation acceptance, including edge cases for unauthorized access attempts, session handling, and proper error messaging.",
  "generatedFiles": [
    {
      "fileName": "project-invitation-access.spec.ts",
      "code": "// Test Case ID: df17591d-a5cb-4764-88ac-60ea300274a3\n// JIRA Issue: RA-104 - Verify that the invited user cannot access the project until the invitation is accepted\n// Priority: High | Category: Negative\n\nimport { test, expect, Page, BrowserContext } from '@playwright/test';\n\ntest.describe('Project Invitation Access Control - RA-104', () => {\n  let adminContext: BrowserContext;\n  let invitedUserContext: BrowserContext;\n  let adminPage: Page;\n  let invitedUserPage: Page;\n  \n  const adminUser = {\n    email: 'admin@robotesta.test',\n    password: 'AdminPass123!'\n  };\n  \n  const invitedUser = {\n    email: 'invited@robotesta.test',\n    password: 'InvitedPass123!'\n  };\n  \n  const testProject = {\n    name: 'Test Project RA-104',\n    id: 'test-project-ra-104'\n  };\n\n  test.beforeEach(async ({ browser }) => {\n    // Setup separate contexts for admin and invited user\n    adminContext = await browser.newContext();\n    invitedUserContext = await browser.newContext();\n    \n    adminPage = await adminContext.newPage();\n    invitedUserPage = await invitedUserContext.newPage();\n    \n    // Navigate to Robotesta application\n    await adminPage.goto('https://www.robotesta.app');\n    await invitedUserPage.goto('https://www.robotesta.app');\n  });\n\n  test.afterEach(async () => {\n    await adminContext.close();\n    await invitedUserContext.close();\n  });\n\n  test('Core Test: Invited user cannot access project before accepting invitation', async () => {\n    // Step 1: Admin logs in and creates/accesses project\n    await test.step('Admin login and project setup', async () => {\n      await adminPage.click('button:has-text(\"Login\")');\n      await adminPage.fill('input[type=\"email\"]', adminUser.email);\n      await adminPage.fill('input[type=\"password\"]', adminUser.password);\n      await adminPage.click('button[type=\"submit\"]');\n      \n      // Wait for successful login\n      await expect(adminPage.locator('[data-testid=\"dashboard\"]')).toBeVisible({ timeout: 10000 });\n      \n      // Navigate to projects or create test project\n      await adminPage.click('a[href*=\"/projects\"]');\n      \n      // Create project if it doesn't exist\n      const projectExists = await adminPage.locator(`text=\"${testProject.name}\"`).isVisible();\n      if (!projectExists) {\n        await adminPage.click('button:has-text(\"Create Project\")');\n        await adminPage.fill('input[name=\"projectName\"]', testProject.name);\n        await adminPage.click('button:has-text(\"Create\")');\n      }\n    });\n\n    // Step 2: Admin invites user to project\n    await test.step('Send project invitation', async () => {\n      await adminPage.click(`text=\"${testProject.name}\"`);\n      await adminPage.click('button:has-text(\"Invite Users\")');\n      await adminPage.fill('input[placeholder*=\"email\"]', invitedUser.email);\n      await adminPage.selectOption('select[name=\"role\"]', 'member');\n      await adminPage.click('button:has-text(\"Send Invitation\")');\n      \n      // Verify invitation sent\n      await expect(adminPage.locator('text=\"Invitation sent successfully\"')).toBeVisible();\n    });\n\n    // Step 3: Invited user logs in (but hasn't accepted invitation)\n    await test.step('Invited user login', async () => {\n      await invitedUserPage.click('button:has-text(\"Login\")');\n      await invitedUserPage.fill('input[type=\"email\"]', invitedUser.email);\n      await invitedUserPage.fill('input[type=\"password\"]', invitedUser.password);\n      await invitedUserPage.click('button[type=\"submit\"]');\n      \n      // Wait for successful login\n      await expect(invitedUserPage.locator('[data-testid=\"dashboard\"]')).toBeVisible({ timeout: 10000 });\n    });\n\n    // Step 4: Attempt to access project directly (should be denied)\n    await test.step('Verify access denial for uninvited user', async () => {\n      // Try to access project directly via URL\n      await invitedUserPage.goto(`https://www.robotesta.app/projects/${testProject.id}`);\n      \n      // Expected Result: Access denied with invitation prompt\n      await expect(invitedUserPage.locator('text=\"Access Denied\"')).toBeVisible();\n      await expect(invitedUserPage.locator('text=\"accept the invitation\"')).toBeVisible();\n      await expect(invitedUserPage.locator('button:has-text(\"Accept Invitation\")')).toBeVisible();\n      \n      // Verify user is not on the project page\n      await expect(invitedUserPage.locator('[data-testid=\"project-dashboard\"]')).not.toBeVisible();\n    });\n\n    // Step 5: Verify project not visible in user's project list\n    await test.step('Verify project not in user project list', async () => {\n      await invitedUserPage.goto('https://www.robotesta.app/projects');\n      await expect(invitedUserPage.locator(`text=\"${testProject.name}\"`)).not.toBeVisible();\n    });\n  });\n\n  test('Edge Case: Direct API access attempt should be blocked', async () => {\n    // Setup invitation scenario\n    await test.step('Setup invitation', async () => {\n      await adminPage.click('button:has-text(\"Login\")');\n      await adminPage.fill('input[type=\"email\"]', adminUser.email);\n      await adminPage.fill('input[type=\"password\"]', adminUser.password);\n      await adminPage.click('button[type=\"submit\"]');\n      \n      await adminPage.goto('https://www.robotesta.app/projects');\n      await adminPage.click('button:has-text(\"Invite Users\")');\n      await adminPage.fill('input[placeholder*=\"email\"]', invitedUser.email);\n      await adminPage.click('button:has-text(\"Send Invitation\")');\n    });\n\n    // Invited user tries API access\n    await test.step('Attempt API access', async () => {\n      await invitedUserPage.click('button:has-text(\"Login\")');\n      await invitedUserPage.fill('input[type=\"email\"]', invitedUser.email);\n      await invitedUserPage.fill('input[type=\"password\"]', invitedUser.password);\n      await invitedUserPage.click('button[type=\"submit\"]');\n\n      // Intercept API calls to project endpoints\n      const apiResponse = await invitedUserPage.request.get(`https://www.robotesta.app/api/projects/${testProject.id}`);\n      \n      // Should return 403 Forbidden or 401 Unauthorized\n      expect([401, 403]).toContain(apiResponse.status());\n    });\n  });\n\n  test('Edge Case: Session handling - invitation status persists across sessions', async () => {\n    // Create invitation\n    await test.step('Create invitation', async () => {\n      await adminPage.click('button:has-text(\"Login\")');\n      await adminPage.fill('input[type=\"email\"]', adminUser.email);\n      await adminPage.fill('input[type=\"password\"]', adminUser.password);\n      await adminPage.click('button[type=\"submit\"]');\n      \n      await adminPage.goto('https://www.robotesta.app/projects');\n      await adminPage.click('button:has-text(\"Invite Users\")');\n      await adminPage.fill('input[placeholder*=\"email\"]', invitedUser.email);\n      await adminPage.click('button:has-text(\"Send Invitation\")');\n    });\n\n    // User logs in, logs out, logs back in\n    await test.step('Test session persistence', async () => {\n      // First login\n      await invitedUserPage.click('button:has-text(\"Login\")');\n      await invitedUserPage.fill('input[type=\"email\"]', invitedUser.email);\n      await invitedUserPage.fill('input[type=\"password\"]', invitedUser.password);\n      await invitedUserPage.click('button[type=\"submit\"]');\n      \n      // Verify access still denied\n      await invitedUserPage.goto(`https://www.robotesta.app/projects/${testProject.id}`);\n      await expect(invitedUserPage.locator('text=\"Access Denied\"')).toBeVisible();\n      \n      // Logout\n      await invitedUserPage.click('[data-testid=\"user-menu\"]');\n      await invitedUserPage.click('button:has-text(\"Logout\")');\n      \n      // Login again\n      await invitedUserPage.click('button:has-text(\"Login\")');\n      await invitedUserPage.fill('input[type=\"email\"]', invitedUser.email);\n      await invitedUserPage.fill('input[type=\"password\"]', invitedUser.password);\n      await invitedUserPage.click('button[type=\"submit\"]');\n      \n      // Verify access still denied after re-login\n      await invitedUserPage.goto(`https://www.robotesta.app/projects/${testProject.id}`);\n      await expect(invitedUserPage.locator('text=\"Access Denied\"')).toBeVisible();\n      await expect(invitedUserPage.locator('text=\"accept the invitation\"')).toBeVisible();\n    });\n  });\n\n  test('Edge Case: Multiple project invitations - access control per project', async () => {\n    const secondProject = {\n      name: 'Second Test Project',\n      id: 'second-test-project'\n    };\n\n    await test.step('Setup multiple projects with invitations', async () => {\n      await adminPage.click('button:has-text(\"Login\")');\n      await adminPage.fill('input[type=\"email\"]', adminUser.email);\n      await adminPage.fill('input[type=\"password\"]', adminUser.password);\n      await adminPage.click('button[type=\"submit\"]');\n      \n      // Create and invite to first project\n      await adminPage.goto('https://www.robotesta.app/projects');\n      await adminPage.click('button:has-text(\"Create Project\")');\n      await adminPage.fill('input[name=\"projectName\"]', testProject.name);\n      await adminPage.click('button:has-text(\"Create\")');\n      \n      await adminPage.click('button:has-text(\"Invite Users\")');\n      await adminPage.fill('input[placeholder*=\"email\"]', invitedUser.email);\n      await adminPage.click('button:has-text(\"Send Invitation\")');\n      \n      // Create second project (no invitation)\n      await adminPage.goto('https://www.robotesta.app/projects');\n      await adminPage.click('button:has-text(\"Create Project\")');\n      await adminPage.fill('input[name=\"projectName\"]', secondProject.name);\n      await adminPage.click('button:has-text(\"Create\")');\n    });\n\n    await test.step('Test access control per project', async () => {\n      await invitedUserPage.click('button:has-text(\"Login\")');\n      await invitedUserPage.fill('input[type=\"email\"]', invitedUser.email);\n      await invitedUserPage.fill('input[type=\"password\"]', invitedUser.password);\n      await invitedUserPage.click('button[type=\"submit\"]');\n      \n      // Access to first project should show invitation prompt\n      await invitedUserPage.goto(`https://www.robotesta.app/projects/${testProject.id}`);\n      await expect(invitedUserPage.locator('text=\"accept the invitation\"')).toBeVisible();\n      \n      // Access to second project should show access denied (no invitation)\n      await invitedUserPage.goto(`https://www.robotesta.app/projects/${secondProject.id}`);\n      await expect(invitedUserPage.locator('text=\"Access Denied\"')).toBeVisible();\n      await expect(invitedUserPage.locator('text=\"You don\\'t have permission\"')).toBeVisible();\n    });\n  });\n\n  test('Error Handling: Invalid project access attempts', async () => {\n    await test.step('Test various invalid access scenarios', async () => {\n      await invitedUserPage.click('button:has-text(\"Login\")');\n      await invitedUserPage.fill('input[type=\"email\"]', invitedUser.email);\n      await invitedUserPage.fill('input[type=\"password\"]', invitedUser.password);\n      await invitedUserPage.click('button[type=\"submit\"]');\n      \n      // Try accessing non-existent project\n      await invitedUserPage.goto('https://www.robotesta.app/projects/non-existent-project');\n      await expect(invitedUserPage.locator('text=\"Project not found\"')).toBeVisible();\n      \n      // Try accessing with malformed project ID\n      await invitedUserPage.goto('https://www.robotesta.app/projects/invalid-id-format');\n      const response = await invitedUserPage.waitForResponse(response => \n        response.url().includes('/projects/invalid-id-format'));\n      expect([400, 404]).toContain(response.status());\n    });\n  });\n\n  test('UI Verification: Proper error messages and navigation', async () => {\n    await test.step('Setup and verify UI elements', async () => {\n      // Setup invitation\n      await adminPage.click('button:has-text(\"Login\")');\n      await adminPage.fill('input[type=\"email\"]', adminUser.email);\n      await adminPage.fill('input[type=\"password\"]', adminUser.password);\n      await adminPage.click('button[type=\"submit\"]');\n      \n      await adminPage.goto('https://www.robotesta.app/projects');\n      await adminPage.click('button:has-text(\"Invite Users\")');\n      await adminPage.fill('input[placeholder*=\"email\"]', invitedUser.email);\n      await adminPage.click('button:has-text(\"Send Invitation\")');\n      \n      // Invited user login and access attempt\n      await invitedUserPage.click